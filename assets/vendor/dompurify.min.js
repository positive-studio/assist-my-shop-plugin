/* AMS fallback sanitizer (allowlist-based). */
(function (window) {
    if (window.DOMPurify) return;

    var ALLOWED_TAGS = {
        a: true, br: true, code: true, del: true, div: true, em: true,
        h1: true, h2: true, h3: true, h4: true, img: true, li: true,
        p: true, span: true, strong: true, ul: true
    };

    var ALLOWED_ATTRS = {
        class: true, href: true, target: true, rel: true, src: true, alt: true, style: true
    };

    function isSafeUrl(url) {
        if (!url) return false;
        var value = String(url).trim().toLowerCase();
        return (
            value.indexOf('http://') === 0 ||
            value.indexOf('https://') === 0 ||
            value.indexOf('mailto:') === 0 ||
            value.indexOf('tel:') === 0 ||
            value.indexOf('/') === 0 ||
            value.indexOf('#') === 0
        );
    }

    function sanitizeNode(node) {
        if (!node || !node.childNodes) return;

        var children = Array.prototype.slice.call(node.childNodes);
        for (var i = 0; i < children.length; i++) {
            var child = children[i];

            if (child.nodeType === 1) {
                var tag = child.tagName.toLowerCase();
                if (!ALLOWED_TAGS[tag]) {
                    child.replaceWith(document.createTextNode(child.textContent || ''));
                    continue;
                }

                var attrs = Array.prototype.slice.call(child.attributes || []);
                for (var j = 0; j < attrs.length; j++) {
                    var attr = attrs[j];
                    var name = attr.name.toLowerCase();
                    var value = attr.value;

                    if (!ALLOWED_ATTRS[name] || name.indexOf('on') === 0) {
                        child.removeAttribute(attr.name);
                        continue;
                    }

                    if ((name === 'href' || name === 'src') && !isSafeUrl(value)) {
                        child.removeAttribute(attr.name);
                        continue;
                    }
                }

                if (tag === 'a') {
                    if (!child.getAttribute('rel')) {
                        child.setAttribute('rel', 'noopener noreferrer');
                    }
                    if (!child.getAttribute('target')) {
                        child.setAttribute('target', '_blank');
                    }
                }

                sanitizeNode(child);
            }
        }
    }

    window.DOMPurify = {
        sanitize: function (input) {
            try {
                var template = document.createElement('template');
                template.innerHTML = String(input || '');
                sanitizeNode(template.content);
                return template.innerHTML;
            } catch (e) {
                var div = document.createElement('div');
                div.textContent = String(input || '');
                return div.innerHTML;
            }
        }
    };
})(window);
