(function(){
const ajaxUrl = (typeof AmsAdmin !== 'undefined' && AmsAdmin.ajax_url) ? AmsAdmin.ajax_url : '/wp-admin/admin-ajax.php';
const nonce = (typeof AmsAdmin !== 'undefined' && AmsAdmin.nonce) ? AmsAdmin.nonce : '';
const i18n = (typeof AmsAdmin !== 'undefined' && AmsAdmin.i18n) ? AmsAdmin.i18n : {};
function t(key, fallback) {
return i18n[key] || fallback;
}
function setStatus(msg) {
const el = document.getElementById('sync-status');
if (el) el.innerHTML = msg;
}
function updateProgress(progress) {
const container = document.getElementById('ams-sync-progress-container');
const bar = document.getElementById('ams-sync-progress');
const text = document.getElementById('ams-sync-progress-text');
if (!container || !bar || !text) return;
if (!progress) {
container.classList.remove('is-visible');
bar.style.width = '0%';
text.innerText = '';
return;
}
container.classList.add('is-visible');
const overall_total = progress.overall_total || 0;
const overall_processed = progress.overall_processed || 0;
const percent = overall_total > 0 ? Math.min(100, Math.round((overall_processed / overall_total) * 100)) : 0;
bar.style.width = percent + '%';
let txt = `${t('overall', 'Overall:')} ${overall_processed} ${t('of', 'of')} ${overall_total} ${t('items', 'items')} (${percent}%)`;
if (progress.current_post_type) {
txt += ` — ${t('currently_syncing', 'Currently syncing:')} ${progress.current_post_type} (${progress.current_processed} ${t('of', 'of')} ${progress.current_total})`;
}
text.innerText = txt;
}
let pollHandle = null;
function pollProgressUntilDone(onDone) {
if (pollHandle) clearInterval(pollHandle);
pollHandle = setInterval(() => {
fetch(ajaxUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: new URLSearchParams({ action: 'ams_get_sync_progress' })
})
.then(r => r.json())
.then(d => {
if (!d.success) {
setStatus(t('failed_fetch_progress', 'Failed to fetch progress'));
clearInterval(pollHandle);
return;
}
const progress = d.progress;
if (progress) {
updateProgress(progress);
setStatus(t('sync_in_progress', 'Sync in progress...'));
} else {
updateProgress(null);
setStatus(t('sync_complete', 'Sync complete — last sync:') + ' ' + (d.last_sync || t('unknown', 'Unknown')));
clearInterval(pollHandle);
if (typeof onDone === 'function') onDone();
}
})
.catch(() => {
setStatus(t('error_polling', 'Error polling sync progress'));
clearInterval(pollHandle);
});
}, 2000);
}
function updateConnectionUI(connected, message) {
const indicator = document.getElementById('ams-connection-indicator');
const text = document.getElementById('ams-connection-status-text');
if (!indicator || !text) return;
indicator.style.background = connected ? '#16a34a' : '#dc2626';
text.textContent = connected
? t('connected', 'Connected')
: `${t('not_connected', 'Not connected')}${message ? ': ' + message : ''}`;
}
function checkConnectionStatus() {
const indicator = document.getElementById('ams-connection-indicator');
const text = document.getElementById('ams-connection-status-text');
if (!indicator || !text) return;
indicator.style.background = '#9ca3af';
text.textContent = t('checking_connection', 'Checking connection...');
fetch(ajaxUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: new URLSearchParams({
action: 'ams_check_connection',
nonce: nonce
})
})
.then(r => r.json())
.then(data => {
if (!data || !data.success || !data.data) {
updateConnectionUI(false, t('unexpected_response', 'Unexpected response'));
return;
}
updateConnectionUI(!!data.data.connected, data.data.message || '');
})
.catch(() => updateConnectionUI(false, t('request_failed', 'Request failed')));
}
document.addEventListener('DOMContentLoaded', function(){
checkConnectionStatus();
const btn = document.getElementById('ams-sync-now');
if (!btn) return;
btn.addEventListener('click', function(){
setStatus(t('scheduling_sync', 'Scheduling background sync...'));
fetch(ajaxUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: new URLSearchParams({ action: 'ams_sync_now', nonce: nonce })
})
.then(r => r.json())
.then(data => {
if (data.success) {
setStatus(t('sync_scheduled', 'Background sync scheduled — polling progress...'));
pollProgressUntilDone(function(){
setTimeout(() => location.reload(), 1200);
});
} else {
setStatus(t('sync_failed', 'Sync failed:') + ' ' + (data.data && data.data.message ? data.data.message : (data.message || t('unknown', 'Unknown'))));
}
})
.catch(() => setStatus(t('failed_schedule', 'Failed to schedule sync')));
});
});
})();